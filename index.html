<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shangri-Apple Contest</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBDk6qFElyOTBFgSPnSHCX1t0RAUuOX_hU",
      authDomain: "apple-tasting.firebaseapp.com",
      projectId: "apple-tasting",
      storageBucket: "apple-tasting.appspot.com",
      messagingSenderId: "511787808121",
      appId: "1:511787808121:web:ccb6529155caa12aa0eba8",
      measurementId: "G-65W20TN30W"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <style>
    body {
      font-family: "Helvetica Neue", sans-serif;
      color: #333;
      margin: 0;
      padding: 20px;
    }

    body {
      background-image: url("https://i.postimg.cc/Kzc3KcbC/Red-apple-smoking-a-cigarette.png");
      background-repeat: repeat;
    }

    h1 {
      text-align: center;
      color: #4C7FE9;
      ;
    }

    .headline {
      background: #fce4e4;
      border: 2px solid #d32f2f;
      border-radius: 12px;
      padding: 0 15px;
      margin: 10px auto;
      max-width: 500px;
    }

    .apple-theme {
      background: #fce4e4;
      border: 2px solid #d32f2f;
      border-radius: 12px;
      padding: 15px;
      margin: 10px auto;
      max-width: 500px;
    }

    select, input {
      padding: 5px;
      margin: 5px;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      background-color: #d32f2f;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
    }

    button:hover {
      background-color: #b71c1c;
    }

    .results {
      background: #f1f8e9;
      padding: 15px;
      margin-top: 20px;
      border-radius: 10px;
      text-align: center;
    }

    .leaderboard-entry {
      margin: 10px 0;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.6s ease forwards;
    }

    .first { font-size: 1.8em; font-weight: bold; }
    .second { font-size: 1.5em; font-weight: 600; }
    .third { font-size: 1.3em; font-weight: 500; }
    .other { font-size: 0.9em; color: #555; }

    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="headline">
    <h1>üçèüçé Shangri-Apple Contest üçéüçè</h1>
  </div>

  <div class="apple-theme">
    <label for="voterName">Your Name:</label>
    <input type="text" id="voterName" placeholder="Enter your name" /><br />

    <label>1st Place:</label>
    <select class="rank" data-rank="1"></select><br />
    <label>2nd Place:</label>
    <select class="rank" data-rank="2"></select><br />
    <label>3rd Place:</label>
    <select class="rank" data-rank="3"></select><br />

    <button onclick="submitRanking()">Submit Rankings</button>
    <button onclick="resetCompetition()" style="background:#888;margin-top:5px;">Reset Competition</button>
  </div>

  <div class="results">
    <h3>Leaderboard</h3>
    <div id="leaderboard"></div>
  </div>

  <canvas id="confetti-canvas" style="position: fixed; top: 0; left: 0; pointer-events: none; width: 100%; height: 100%; z-index: 999;"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script>
    const appleVarietals = [
      "Cosmic Crisp", "Honeycrisp", "Gala", "Pink Lady", "Envy", "Grammy Smith"
    ];

    const voterInput = document.getElementById("voterName");
    const rankSelects = document.querySelectorAll(".rank");
    const leaderboard = document.getElementById("leaderboard");
    let previousFirstPlace = null;

    function populateRankDropdowns() {
      rankSelects.forEach(sel => {
        sel.innerHTML = "";
        const placeholder = document.createElement("option");
        placeholder.textContent = "-- Choose --";
        placeholder.disabled = true;
        placeholder.selected = true;
        sel.appendChild(placeholder);

        appleVarietals.forEach(a => {
          const opt = document.createElement("option");
          opt.value = a;
          opt.textContent = a;
          sel.appendChild(opt);
        });
      });
    }

    async function submitRanking() {
      const voter = voterInput.value.trim();
      if (!voter) return alert("Please enter your name.");

      const selected = Array.from(rankSelects).map(sel => sel.value);
      if (new Set(selected).size !== 3 || selected.includes("")) {
        return alert("Each place must be a unique apple!");
      }

      const voterRef = db.collection("voters").doc(voter);
      const voterSnap = await voterRef.get();
      if (voterSnap.exists) {
        return alert("You have already voted!");
      }

      await voterRef.set({ voted: true });
      const scoresRef = db.collection("scores");
      const batch = db.batch();

      [[selected[0], 3], [selected[1], 2], [selected[2], 1]].forEach(([apple, pts]) => {
        const ref = scoresRef.doc(apple);
        batch.set(ref, { name: apple, score: firebase.firestore.FieldValue.increment(pts) }, { merge: true });
      });

      await batch.commit();
    }

    function listenToScores() {
      db.collection("scores").onSnapshot(snap => {
        const entries = [];
        snap.forEach(doc => entries.push([doc.id, doc.data().score || 0]));

        const sorted = entries.sort((a, b) => b[1] - a[1]).filter(([_, score]) => score > 0);
        leaderboard.innerHTML = "";

        const newFirstPlace = sorted[0]?.[0];
        if (previousFirstPlace && newFirstPlace !== previousFirstPlace) {
          triggerConfetti();
        }
        previousFirstPlace = newFirstPlace;

        sorted.forEach(([name, score], index) => {
          const el = document.createElement("div");
          el.className = "leaderboard-entry";

          if (index === 0) {
            el.classList.add("first");
            el.textContent = `ü•á 1st: ${name} (${score} pts)`;
          } else if (index === 1) {
            el.classList.add("second");
            el.textContent = `ü•à 2nd: ${name} (${score} pts)`;
          } else if (index === 2) {
            el.classList.add("third");
            el.textContent = `ü•â 3rd: ${name} (${score} pts)`;
          } else {
            el.classList.add("other");
            el.textContent = `${index + 1}th: ${name} (${score} pts)`;
          }

          leaderboard.appendChild(el);
        });
      });
    }

    async function resetCompetition() {
      if (!confirm("Are you sure you want to reset all scores and votes?")) return;

      const scoreDocs = await db.collection("scores").get();
      const voterDocs = await db.collection("voters").get();
      const batch = db.batch();

      scoreDocs.forEach(doc => batch.delete(doc.ref));
      voterDocs.forEach(doc => batch.delete(doc.ref));

      await batch.commit();
      leaderboard.innerHTML = "<p>Leaderboard has been reset.</p>";
    }

    function triggerConfetti() {
      const duration = 2000;
      const animationEnd = Date.now() + duration;
      const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 999 };
      const interval = setInterval(() => {
        const timeLeft = animationEnd - Date.now();
        if (timeLeft <= 0) return clearInterval(interval);
        confetti(Object.assign({}, defaults, {
          particleCount: 50 * (timeLeft / duration),
          origin: { x: Math.random(), y: Math.random() - 0.2 }
        }));
      }, 250);
    }

    populateRankDropdowns();
    listenToScores();
  </script>
</body>
</html>
